name: Documentation review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  documentation-review:
    runs-on: ubuntu-latest
    name: Check for stale documentation
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Review documentation for staleness
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            You are a documentation review agent for the **tbsim** project, a TB (tuberculosis) simulation library built on the Starsim framework. Your job is to review this pull request diff and flag any existing documentation that has become stale or inaccurate because of the changes in the PR. You do **not** suggest replacement text — you only identify what needs attention and explain why.

            ## Step 1 — Understand the changes

            1. Fetch the full PR diff.
            2. For each changed file, determine:
               - Which public functions, classes, methods, or constants were added, removed, renamed, or had their signatures changed.
               - Which default parameter values changed.
               - Which behavioral semantics changed (e.g. a function now returns a different type, raises different exceptions, or has new side-effects).
               - Which modules or packages were restructured (files moved, renamed, split, or merged).

            ## Step 2 — Discover documentation surfaces

            Dynamically locate all documentation that could reference the changed code. Do **not** rely on a hard-coded list of files — the repository structure may change over time.

            ### 2a. Inline and class-level documentation (within source files)
            - Docstrings on the changed functions/methods/classes themselves.
            - Docstrings on **callers** or **overrides** of changed functions, if they reference the old behavior.
            - Inline `# comments` adjacent to changed code that describe the old logic.
            - Type hints or type-alias docstrings that reference removed or renamed types.

            ### 2b. Module-level and package-level documentation
            - Module docstrings (top of `.py` files) that summarize capabilities now altered.
            - `__init__.py` docstrings or `__all__` lists that expose items whose names or existence changed.
            - Search for all `README.md` files in the repository (excluding `.venv/`, `.git/`, and other non-project directories) and check any that describe packages or directories affected by the PR.

            ### 2c. Project-level documentation
            - The root `README.md`.
            - All Markdown files (`*.md`) under the `docs/` directory tree, including any subdirectories.

            ### 2d. Tutorials and examples
            - All Jupyter notebooks (`*.ipynb`) found anywhere in the repository (excluding `.venv/`).
            - All Python example scripts found under directories whose name contains `example` or `examples` (e.g. `tbsim_examples/`).

            ### 2e. Configuration and metadata
            - `pyproject.toml` — project description, entry points, dependency lists, or metadata that mention changed items.
            - `mkdocs.yml` (or any `mkdocs*.yml` variant) — navigation entries, page titles, or plugin config referencing changed pages or API objects.

            ## Step 3 — Scan for staleness

            For every change identified in Step 1, search the documentation surfaces discovered in Step 2 for references to the old names, signatures, behaviors, or structures. Specifically look for:
            - Direct mentions of renamed or removed functions, classes, methods, parameters, or constants.
            - Code snippets, import statements, or usage examples that use the old API.
            - Prose descriptions that assume the old behavior, default values, or return types.
            - Navigation entries or section headings that reference relocated or deleted modules.

            ## Step 4 — Report findings

            For each piece of documentation that needs attention, leave a **review comment on the PR** containing:

            1. **What changed** — the specific code change (function renamed, parameter removed, behavior altered, etc.).
            2. **Where documentation is affected** — the exact file and, when possible, the line range or section heading.
            3. **Why it needs updating** — a brief explanation of the mismatch between the current documentation and the new code.

            Do **not** propose replacement text or rewrite documentation. Only flag and explain.

            ## Formatting rules

            - Use one comment per distinct documentation location that needs updating. Do not combine unrelated findings into a single comment.
            - If the same code change affects multiple documentation locations, reference the code change once and list each affected location in its own comment.
            - If the PR changes only non-public internals with zero documentation surface, leave a single summary comment confirming that no documentation updates are required.
            - Keep comments concise and factual. Avoid subjective language.
